<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Skill Matrix</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
        }

        .page-shell {
            max-width: 1320px;
            margin: 0 auto;
            padding: 24px 16px 40px;
        }

        /* HEADER */
        .header {
            background: #ffffffcc;
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 20px 24px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.06);
            border: 1px solid rgba(0,0,0,0.06);
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
        }

        .header h1 {
            font-size: 26px;
            font-weight: 650;
            letter-spacing: -0.02em;
        }

        .header p {
            font-size: 14px;
            color: #6e6e73;
        }

        /* KPI CARDS */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 14px;
            margin-top: 16px;
        }

        .stat-card {
            background: #ffffff;
            border-radius: 20px;
            padding: 16px 18px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.04);
            border: 1px solid rgba(0,0,0,0.04);
        }

        .stat-icon {
            width: 38px;
            height: 38px;
            border-radius: 999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            background: #f5f5f7;
        }

        .stat-text {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .stat-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #6e6e73;
        }

        .stat-number {
            font-size: 24px;
            font-weight: 650;
        }

        .last-modified {
            font-size: 11px;
            color: #6e6e73;
            font-style: italic;
        }

        /* CONTROLS */
        .controls {
            background: #ffffff;
            border-radius: 24px;
            padding: 18px 20px 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.04);
            margin-bottom: 18px;
        }

        .controls-wrapper {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .info-message {
            font-size: 12px;
            color: #6e6e73;
        }

        .view-toggle {
            display: inline-flex;
            border-radius: 999px;
            padding: 2px;
            background: #f5f5f7;
            margin-top: 8px;
            gap: 4px;
        }

        .toggle-btn {
            border: none;
            background: transparent;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 12px;
            cursor: pointer;
            color: #3a3a3c;
        }

        .toggle-btn.active {
            background: #ffffff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            color: #0071e3;
            font-weight: 600;
        }

        /* FILTER ROW ‚Äì all in one line */
        .filter-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: flex-end;
            margin-top: 10px;
        }

        .filter-row > div {
            min-width: 170px;
            flex: 1;
        }

        label {
            display: block;
            font-size: 11px;
            font-weight: 500;
            color: #6e6e73;
            margin-bottom: 4px;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 8px 10px;
            border-radius: 999px;
            border: 1px solid #d2d2d7;
            font-size: 13px;
            background: #f9f9fb;
            outline: none;
            transition: all 0.15s ease;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            border-color: #0071e3;
            background: #ffffff;
            box-shadow: 0 0 0 2px rgba(0,113,227,0.2);
        }

        /* BUTTONS */
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
            align-items: center;
        }

        .btn {
            border-radius: 999px;
            border: none;
            cursor: pointer;
            font-size: 12px;
            padding: 7px 14px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
            transition: all 0.15s ease;
        }

        .btn-primary {
            background: #0071e3;
            color: #fff;
        }

        .btn-primary:hover {
            background: #005bb5;
        }

        .btn-secondary {
            background: #f5f5f7;
            color: #1d1d1f;
        }

        .btn-secondary:hover {
            background: #e5e5ea;
        }

        .btn-success {
            background: #34c759;
            color: #ffffff;
        }

        .btn-success:hover {
            background: #28a745;
        }

        /* SKILL LEGEND ‚Äì under buttons, in a line */
        .legend-shell {
            background: #f9f9fb;
            border-radius: 18px;
            padding: 10px 12px;
            border: 1px solid rgba(0,0,0,0.04);
            margin-top: 10px;
        }

        .legend-title {
            font-size: 11px;
            font-weight: 600;
            color: #6e6e73;
            margin-bottom: 6px;
        }

        .skill-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .skill-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px;
            white-space: nowrap;
        }

        .skill-chip .chip-num {
            font-weight: 600;
            min-width: 14px;
            text-align: center;
        }

        /* LEVEL COLORS */
        .level-0 { background: #f5f5f5; color: #8e8e93; }
        .level-1 { background: #ffebee; color: #c62828; }
        .level-2 { background: #fff3e0; color: #e65100; }
        .level-3 { background: #fff9c4; color: #f57f17; }
        .level-4 { background: #e8f5e9; color: #2e7d32; }
        .level-5 { background: #c8e6c9; color: #1b5e20; }

        /* TABLE WRAPPER */
        .table-container {
            background: #ffffff;
            border-radius: 24px;
            box-shadow: 0 14px 36px rgba(0,0,0,0.06);
            border: 1px solid rgba(0,0,0,0.04);
            overflow: hidden;
        }

        .table-wrapper {
            overflow: auto;
            max-height: 70vh;
            position: relative;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            table-layout: auto;
        }

        thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #ffffff;
        }

        .header-level-1 {
            background: #0b84ff;
            color: #ffffff;
            text-align: center;
            padding: 10px 8px;
            border: 1px solid #0b6ad1;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            z-index: 10;
        }

        .header-level-2 {
            background: #eef3ff;
            color: #1d1d1f;
            text-align: center;
            padding: 8px 6px;
            border: 1px solid #d4ddff;
            font-size: 11px;
            z-index: 10;
        }

        .header-level-3 {
            background: #f9fafb;
            padding: 7px 6px;
            border: 1px solid #e4e4ea;
            white-space: nowrap;
            cursor: pointer;
            font-size: 11px;
            z-index: 10;
        }

        .header-basic {
            background: #f9fafb;
            padding: 8px 6px;
            border: 1px solid #e4e4ea;
            font-weight: 600;
            white-space: nowrap;
        }

        td {
            padding: 8px 6px;
            border: 1px solid #f0f0f3;
            text-align: center;
            background: #ffffff;
        }

        tbody tr:hover td {
            background: #f5f5f7;
        }

        /* STICKY COLUMNS (first 3 + last) */
        .sticky-col {
            position: sticky;
            background: #ffffff;
            z-index: 40;
        }

        th.sticky-col-1, td.sticky-col-1 { left: 0; }
        th.sticky-col-2, td.sticky-col-2 { left: 60px; }
        th.sticky-col-3, td.sticky-col-3 { left: 150px; }

        th.sticky-col-last, td.sticky-col-last {
            right: 0;
            position: sticky;
        }

        thead th.sticky-col-1,
        thead th.sticky-col-2,
        thead th.sticky-col-3,
        thead th.sticky-col-last {
            background: #ffffff;
            z-index: 50; /* above blue band */
        }

        /* SKILL LEVEL CELLS */
        .skill-level {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 999px;
            min-width: 26px;
            cursor: pointer;
            font-size: 11px;
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }

        .skill-level:hover {
            transform: scale(1.06);
            box-shadow: 0 0 6px rgba(0,0,0,0.16);
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 999px;
            font-weight: 600;
            font-size: 10px;
        }

        .status-Billable,
        .status-Active { background: #e8f5e9; color: #2e7d32; }
        .status-Maternity,
        .status-Developmental { background: #fff3e0; color: #e65100; }
        .status-Resigned { background: #ffebee; color: #c62828; }
        .status-Shadow,
        .status-OPAS,
        .status-Futurebillable { background: #e3f2fd; color: #1976d2; }

        .export-section {
            padding: 10px 16px;
            background: #f9fafb;
            font-size: 11px;
            color: #6e6e73;
            display: flex;
            justify-content: space-between;
        }

        .action-cell {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
        }

        /* Minimal action icons */
        .icon-btn {
            width: 24px;
            height: 24px;
            border-radius: 999px;
            border: 1px solid #e5e5ea;
            background: #f5f5f7;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.15s ease;
            color: #3a3a3c;
        }

        .icon-btn:hover {
            background: #e5e5ea;
            box-shadow: 0 2px 6px rgba(0,0,0,0.12);
        }

        .icon-edit { }
        .icon-delete { color: #c62828; }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.45);
            overflow: auto;
        }

        .modal-content {
            background-color: #ffffff;
            margin: 5% auto;
            padding: 24px;
            border-radius: 20px;
            width: 90%;
            max-width: 620px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.25);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 16px;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 18px;
            font-weight: 600;
        }

        .close {
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }

        .form-group { margin-bottom: 12px; }

        .modal-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 16px;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .header-top {
                flex-direction: column;
                align-items: flex-start;
            }
            .stats-bar {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
<div class="page-shell">
    <!-- HEADER + KPI -->
    <div class="header">
        <div class="header-top">
            <div>
                <h1>Team Skill Matrix</h1>
                <p>Monitor expertise, manage allocations, and visualize team capabilities.</p>
            </div>
            <span id="lastModified" class="last-modified">Last Modified: Loading‚Ä¶</span>
        </div>

        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-icon">üë•</div>
                <div class="stat-text">
                    <span class="stat-label">TOTAL MEMBERS</span>
                    <span class="stat-number" id="totalCount">0</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üíº</div>
                <div class="stat-text">
                    <span class="stat-label">BILLABLE</span>
                    <span class="stat-number" id="activeCount">0</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìå</div>
                <div class="stat-text">
                    <span class="stat-label">CLIENT ROLES</span>
                    <span class="stat-number" id="clientRoleCount">0</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üÜï</div>
                <div class="stat-text">
                    <span class="stat-label">NEW JOINEES</span>
                    <span class="stat-number" id="newJoineeCount">0</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üö™</div>
                <div class="stat-text">
                    <span class="stat-label">RESIGNED</span>
                    <span class="stat-number" id="resignedCount">0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- CONTROLS -->
    <div class="controls">
        <div class="controls-wrapper">
            <div>
                <div class="info-message">
                    üí° Tip: click any skill number (0‚Äì5) to edit inline.
                </div>

                <div class="view-toggle">
                    <button class="toggle-btn active" onclick="toggleView('all', event)">üìä All Skills</button>
                    <button class="toggle-btn" onclick="toggleView('domain', event)">üéØ Domain Only</button>
                    <button class="toggle-btn" onclick="toggleView('tools', event)">üîß Tools Only</button>
                </div>

                <!-- ONE HORIZONTAL FILTER ROW -->
                <div class="filter-row">
                    <div>
                        <label>üîç Search</label>
                        <input type="text" id="searchInput" placeholder="Name or ID...">
                    </div>
                    <div>
                        <label>üìç Status</label>
                        <select id="statusFilter"><option value="">All</option></select>
                    </div>
                    <div>
                        <label>üìä Role</label>
                        <select id="roleFilter"><option value="">All</option></select>
                    </div>
                    <div>
                        <label>üë§ Manager</label>
                        <select id="managerFilter"><option value="">All</option></select>
                    </div>
                    <div>
                        <label>üìÇ Domain (Skill &gt; 0)</label>
                        <select id="domainSkillFilter">
                            <option value="">All Domain Skills</option>
                        </select>
                    </div>
                    <div>
                        <label>üõ†Ô∏è Tool (Skill &gt; 0)</label>
                        <select id="toolSkillFilter">
                            <option value="">All Tools</option>
                        </select>
                    </div>
                </div>

                <!-- BUTTONS -->
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="openAddModal()">‚ûï Add Member</button>
                    <button class="btn btn-secondary" onclick="resetFilters()">üîÑ Reset</button>
                    <button class="btn btn-primary" onclick="saveAllChanges()">üíæ Save Changes</button>
                </div>

                <!-- SKILL LEGEND (INLINE) -->
                <div class="legend-shell">
                    <div class="legend-title">SKILL LEVELS</div>
                    <div class="skill-legend">
                        <span class="skill-chip level-0" title="0 ‚Äì Not aware">
                            <span class="chip-num">0</span> Not Aware
                        </span>
                        <span class="skill-chip level-1" title="1 ‚Äì Trained">
                            <span class="chip-num">1</span> Trained
                        </span>
                        <span class="skill-chip level-2" title="2 ‚Äì At least worked on a POC">
                            <span class="chip-num">2</span> POC
                        </span>
                        <span class="skill-chip level-3" title="3 ‚Äì Worked on a complete project">
                            <span class="chip-num">3</span> Project
                        </span>
                        <span class="skill-chip level-4" title="4 ‚Äì Independently handled project">
                            <span class="chip-num">4</span> Solo
                        </span>
                        <span class="skill-chip level-5" title="5 ‚Äì Guides others and solves doubts">
                            <span class="chip-num">5</span> Expert
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TABLE -->
    <div class="table-container">
        <div class="table-wrapper">
            <table id="skillTable">
                <thead>
                <tr id="headerRow1">
                    <th rowspan="3" class="header-basic sticky-col sticky-col-1">S.No</th>
                    <th rowspan="3" class="header-basic sticky-col sticky-col-2">ID</th>
                    <th rowspan="3" class="header-basic sticky-col sticky-col-3">Name</th>
                    <th rowspan="3" class="header-basic">Status</th>
                    <th rowspan="3" class="header-basic">Alignment</th>
                    <th rowspan="3" class="header-basic">Manager</th>
                    <th rowspan="3" class="header-basic">Role</th>
                    <th rowspan="3" class="header-basic">Client</th>
                    <th colspan="15" class="header-level-1 domain-col">DOMAIN EXPERTISE</th>
                    <th colspan="18" class="header-level-1 tools-col">TOOLS &amp; TECHNOLOGIES</th>
                    <th rowspan="3" class="header-basic sticky-col sticky-col-last">Actions</th>
                </tr>
                <tr id="headerRow2">
                    <th colspan="15" class="header-level-2 domain-col">Core Domain Skills</th>
                    <th colspan="4" class="header-level-2 tools-col">Data Viz</th>
                    <th colspan="5" class="header-level-2 tools-col">Programming</th>
                    <th colspan="7" class="header-level-2 tools-col">Data Mgmt</th>
                    <th colspan="2" class="header-level-2 tools-col">Cloud</th>
                </tr>
                <tr id="headerRow3">
                    <th class="header-level-3 sortable domain-col" data-column="marketAccess">Market Access</th>
                    <th class="header-level-3 sortable domain-col" data-column="pricingAnalytics">Pricing</th>
                    <th class="header-level-3 sortable domain-col" data-column="salesForce">SFE</th>
                    <th class="header-level-3 sortable domain-col" data-column="incentiveComp">IC</th>
                    <th class="header-level-3 sortable domain-col" data-column="patientData">Patient Data</th>
                    <th class="header-level-3 sortable domain-col" data-column="forecasting">Forecasting</th>
                    <th class="header-level-3 sortable domain-col" data-column="pharmaAnalytics">Pharma</th>
                    <th class="header-level-3 sortable domain-col" data-column="marketingAnalytics">Marketing</th>
                    <th class="header-level-3 sortable domain-col" data-column="supplyChain">Supply Chain</th>
                    <th class="header-level-3 sortable domain-col" data-column="fpna">FP&amp;A</th>
                    <th class="header-level-3 sortable domain-col" data-column="targeting">Targeting</th>
                    <th class="header-level-3 sortable domain-col" data-column="dataEngineering">Data Eng</th>
                    <th class="header-level-3 sortable domain-col" data-column="etl">ETL</th>
                    <th class="header-level-3 sortable domain-col" data-column="advancedAnalytics">Adv Analytics</th>
                    <th class="header-level-3 sortable domain-col" data-column="dataScience">Data Sci</th>

                    <th class="header-level-3 sortable tools-col" data-column="excelVBA">Excel/VBA</th>
                    <th class="header-level-3 sortable tools-col" data-column="tableau">Tableau</th>
                    <th class="header-level-3 sortable tools-col" data-column="powerBI">Power BI</th>
                    <th class="header-level-3 sortable tools-col" data-column="ssrs">SSRS</th>
                    <th class="header-level-3 sortable tools-col" data-column="sql">SQL</th>
                    <th class="header-level-3 sortable tools-col" data-column="python">Python</th>
                    <th class="header-level-3 sortable tools-col" data-column="sas">SAS</th>
                    <th class="header-level-3 sortable tools-col" data-column="r">R</th>
                    <th class="header-level-3 sortable tools-col" data-column="powerQuery">P.Query</th>
                    <th class="header-level-3 sortable tools-col" data-column="apacheAirflow">Airflow</th>
                    <th class="header-level-3 sortable tools-col" data-column="ssis">SSIS</th>
                    <th class="header-level-3 sortable tools-col" data-column="awsGlue">Glue</th>
                    <th class="header-level-3 sortable tools-col" data-column="adf">ADF</th>
                    <th class="header-level-3 sortable tools-col" data-column="alteryx">Alteryx</th>
                    <th class="header-level-3 sortable tools-col" data-column="knime">KNIME</th>
                    <th class="header-level-3 sortable tools-col" data-column="talend">Talend</th>
                    <th class="header-level-3 sortable tools-col" data-column="databricks">Databricks</th>
                    <th class="header-level-3 tools-col">Cloud</th>
                </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        <div class="export-section">
            <div>Showing <strong id="showingCount">0</strong> of <strong id="totalRecords">0</strong> records</div>
        </div>
    </div>
</div>

<!-- MODAL -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>‚úèÔ∏è Edit Employee Details</h2>
            <span class="close" onclick="closeEditModal()">&times;</span>
        </div>

        <div class="form-group">
            <label for="editName">Full Name</label>
            <input type="text" id="editName" placeholder="Enter full name">
        </div>

        <div class="filter-row" style="margin-top:0;">
            <div class="form-group">
                <label for="editId">Employee ID</label>
                <input type="number" id="editId" placeholder="ID">
            </div>
            <div class="form-group">
                <label for="editClientRole">Client Role?</label>
                <select id="editClientRole">
                    <option value="Y">Yes</option>
                    <option value="N">No</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label for="editStatus">Status</label>
            <select id="editStatus">
                <option value="Billable">Billable</option>
                <option value="Active">Active</option>
                <option value="Shadow">Shadow</option>
                <option value="Maternity">Maternity</option>
                <option value="Resigned">Resigned</option>
                <option value="OPAS">OPAS</option>
                <option value="Developmental">Developmental</option>
                <option value="Future billable">Future billable</option>
            </select>
        </div>

        <div class="form-group">
            <label for="editNewJoinee">New Joinee? (Used for KPI)</label>
            <select id="editNewJoinee">
                <option value="N">No</option>
                <option value="Y">Yes</option>
            </select>
        </div>

        <div class="form-group">
            <label for="editAlignment">Alignment</label>
            <select id="editAlignment"></select>
        </div>

        <div class="form-group">
            <label for="editManager">Reporting Manager</label>
            <select id="editManager"></select>
        </div>

        <div class="form-group">
            <label for="editRole">Role</label>
            <select id="editRole"></select>
        </div>

        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveEditChanges()">üíæ Save Changes</button>
        </div>
    </div>
</div>

<script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxW_3-qr7J-aTam5kyOzcG4CgAB7J1MlnaI3TtKYDOi6InPwWCiK75fYi_tGmAQb0JK/exec";

    let teamData = [];
    let filteredData = [];

    const domainSkills = ['marketAccess', 'pricingAnalytics', 'salesForce', 'incentiveComp', 'patientData', 'forecasting', 'pharmaAnalytics', 'marketingAnalytics', 'supplyChain', 'fpna', 'targeting', 'dataEngineering', 'etl', 'advancedAnalytics', 'dataScience'];
    const toolSkills   = ['excelVBA', 'tableau', 'powerBI', 'ssrs', 'sql', 'python', 'sas', 'r', 'powerQuery', 'apacheAirflow', 'ssis', 'awsGlue', 'adf', 'alteryx', 'knime', 'talend', 'databricks'];

    const skillLabels = {
        marketAccess: 'Market Access', pricingAnalytics:'Pricing', salesForce:'SFE', incentiveComp:'IC',
        patientData:'Patient Data', forecasting:'Forecasting', pharmaAnalytics:'Pharma', marketingAnalytics:'Marketing',
        supplyChain:'Supply Chain', fpna:'FP&A', targeting:'Targeting', dataEngineering:'Data Eng', etl:'ETL',
        advancedAnalytics:'Advanced', dataScience:'Data Sci', excelVBA:'Excel', tableau:'Tableau',
        powerBI:'Power BI', ssrs:'SSRS', sql:'SQL', python:'Python', sas:'SAS', r:'R', powerQuery:'Power Query',
        apacheAirflow:'Airflow', ssis:'SSIS', awsGlue:'AWS Glue', adf:'ADF', alteryx:'Alteryx',
        knime:'KNIME', talend:'Talend', databricks:'Databricks'
    };

    const skillLevelDescriptions = {
        0: "Not aware",
        1: "Trained",
        2: "At least worked on a POC",
        3: "Worked on a complete project",
        4: "Independently handled project",
        5: "Guides others and solves doubts"
    };

    let sortColumn = null;
    let sortDirection = 'asc';
    let currentEditingId = null;
    let currentView = 'all';
    let isAddingNew = false;

    async function init() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '<tr><td colspan="45" style="text-align:center;padding:20px;">‚è≥ Loading data...</td></tr>';

        try {
            const response = await fetch(WEB_APP_URL);
            const data = await response.json();

            if (Array.isArray(data)) {
                teamData = data;
                teamData.forEach(p => {
                    domainSkills.forEach(s => p[s] = parseInt(p[s]) || 0);
                    toolSkills.forEach(s => p[s] = parseInt(p[s]) || 0);
                });
            }

            filteredData = [...teamData];
            populateFilters();
            renderTable();
            updateStats();
            attachEventListeners();
            setInitialLastModifiedFromData();
        } catch (error) {
            console.error(error);
            tbody.innerHTML = `<tr><td colspan="45" style="text-align:center;color:red;padding:20px;">‚ùå Error loading data. Error: ${error.message}</td></tr>`;
        }
    }

    function attachEventListeners() {
        document.querySelectorAll('.sortable')
            .forEach(th => th.addEventListener('click', () => sortTable(th.dataset.column)));

        document.getElementById('searchInput').addEventListener('input', applyFilters);
        ['statusFilter','roleFilter','managerFilter','domainSkillFilter','toolSkillFilter'].forEach(id => {
            document.getElementById(id).addEventListener('change', applyFilters);
        });

        window.onclick = function(e) {
            if(e.target === document.getElementById('editModal')) closeEditModal();
        };

        window.addEventListener('resize', updateStickyColumns);
    }

    async function saveAllChanges() {
        const btn = document.querySelector('button[onclick="saveAllChanges()"]');
        const originalText = btn.textContent;
        btn.textContent = "‚è≥ Saving...";
        btn.disabled = true;

        try {
            const response = await fetch(WEB_APP_URL, {
                method: "POST",
                body: JSON.stringify(teamData),
                headers: { "Content-Type": "text/plain" }
            });
            const result = await response.json();

            if (result.status === "success") {
                alert(`‚úÖ Successfully saved!`);
                updateLastModified();
            } else {
                throw new Error(result.message || "Unknown error");
            }
        } catch (error) {
            alert("‚ùå Failed to save: " + error.message);
        } finally {
            btn.textContent = originalText;
            btn.disabled = false;
        }
    }

    function setInitialLastModifiedFromData() {
        let latest = null;
        teamData.forEach(p => {
            if (p.lastModified) {
                const d = new Date(p.lastModified);
                if (!isNaN(d) && (!latest || d > latest)) latest = d;
            }
        });
        if (!latest) latest = new Date();
        const label = document.getElementById('lastModified');
        label.textContent = "Last Modified: " + latest.toLocaleString();
    }

    function updateLastModified() {
        const now = new Date();
        document.getElementById('lastModified').textContent =
            "Last Modified: " + now.toLocaleString();
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        if (filteredData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="45" style="text-align:center;padding:20px;">No records found</td></tr>';
            document.getElementById('showingCount').textContent = 0;
            return;
        }

        filteredData.forEach(p => {
            const tr = document.createElement('tr');
            const statusClass = 'status-' + (p.status || '').replace(/[\s-]/g, '');

            let html = `
                <td class="sticky-col sticky-col-1">${p.sno}</td>
                <td class="sticky-col sticky-col-2"><strong>${p.id}</strong></td>
                <td class="sticky-col sticky-col-3"><strong>${p.name}</strong></td>
                <td><span class="status-badge ${statusClass}">${p.status || ''}</span></td>
                <td>${p.alignment || ''}</td>
                <td>${p.manager || ''}</td>
                <td>${p.role || ''}</td>
                <td><strong>${p.clientRole || ''}</strong></td>`;

            if (currentView !== 'tools') {
                domainSkills.forEach(s => {
                    const val = p[s] ?? 0;
                    const desc = skillLevelDescriptions[val] || '';
                    html += `<td class="domain-col">
                                <span class="skill-level level-${val}"
                                      title="${desc}"
                                      onclick="makeSkillEditable(this,'${p.id}','${s}')">${val}</span>
                            </td>`;
                });
            }
            if (currentView !== 'domain') {
                toolSkills.forEach(s => {
                    const val = p[s] ?? 0;
                    const desc = skillLevelDescriptions[val] || '';
                    html += `<td class="tools-col">
                                <span class="skill-level level-${val}"
                                      title="${desc}"
                                      onclick="makeSkillEditable(this,'${p.id}','${s}')">${val}</span>
                            </td>`;
                });
                html += `<td class="tools-col">-</td>`;
            }

            html += `<td class="sticky-col sticky-col-last">
                        <div class="action-cell">
                            <button class="icon-btn icon-edit" onclick="openEditModal('${p.id}')" aria-label="Edit">‚úè</button>
                            <button class="icon-btn icon-delete" onclick="deleteUser('${p.id}')" aria-label="Delete">üóë</button>
                        </div>
                    </td>`;

            tr.innerHTML = html;
            tbody.appendChild(tr);
        });

        document.getElementById('showingCount').textContent = filteredData.length;
        document.getElementById('totalRecords').textContent = teamData.length;

        updateStickyColumns();
    }

    function updateStickyColumns() {
        const table = document.getElementById('skillTable');
        if (!table || !table.tHead) return;

        const snoTh   = table.querySelector('th.sticky-col-1');
        const idTh    = table.querySelector('th.sticky-col-2');
        const nameTh  = table.querySelector('th.sticky-col-3');
        const rows    = table.tBodies[0]?.rows || [];

        if (!snoTh || !idTh || !nameTh) return;

        const left1 = 0;
        const left2 = left1 + snoTh.offsetWidth;
        const left3 = left2 + idTh.offsetWidth;

        snoTh.style.left = left1 + 'px';
        idTh.style.left = left2 + 'px';
        nameTh.style.left = left3 + 'px';

        Array.from(rows).forEach(row => {
            const c1 = row.querySelector('td.sticky-col-1');
            const c2 = row.querySelector('td.sticky-col-2');
            const c3 = row.querySelector('td.sticky-col-3');
            if (c1) c1.style.left = left1 + 'px';
            if (c2) c2.style.left = left2 + 'px';
            if (c3) c3.style.left = left3 + 'px';
        });
    }

    function makeSkillEditable(el, empId, skill) {
        const orig = el.textContent.trim();
        el.setAttribute('contenteditable', 'true');
        el.focus();

        const onBlur = () => {
            el.setAttribute('contenteditable', 'false');
            const val = parseInt(el.textContent);
            if (isNaN(val) || val < 0 || val > 5) {
                el.textContent = orig;
                alert('Value must be between 0 and 5.');
            } else {
                const pIdx = teamData.findIndex(p => p.id == empId);
                if (pIdx !== -1) {
                    teamData[pIdx][skill] = val;
                    el.className = `skill-level level-${val}`;
                    el.title = skillLevelDescriptions[val] || '';
                    updateStats();
                    updateLastModified();
                }
            }
        };
        el.addEventListener('blur', onBlur, { once: true });
        el.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                el.blur();
            }
        });
    }

    function populateFilters() {
        const statuses = [...new Set(teamData.map(d => d.status))].filter(s => s).sort();
        const roles    = [...new Set(teamData.map(d => d.role))].filter(r => r).sort();
        const managers = [...new Set(teamData.map(d => d.manager))].filter(m => m).sort();

        const fillSelect = (id, data, firstLabel) => {
            const select = document.getElementById(id);
            select.innerHTML = `<option value="">${firstLabel}</option>`;
            data.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item;
                opt.textContent = item;
                select.appendChild(opt);
            });
        };
        fillSelect('statusFilter', statuses, 'All');
        fillSelect('roleFilter', roles, 'All');
        fillSelect('managerFilter', managers, 'All');

        const dFilter = document.getElementById('domainSkillFilter');
        if (dFilter.options.length === 1) {
            domainSkills.forEach(s => {
                const o = document.createElement('option');
                o.value = s;
                o.textContent = skillLabels[s];
                dFilter.appendChild(o);
            });
            const tFilter = document.getElementById('toolSkillFilter');
            toolSkills.forEach(s => {
                const o = document.createElement('option');
                o.value = s;
                o.textContent = skillLabels[s];
                tFilter.appendChild(o);
            });
        }
    }

    function applyFilters() {
        const term   = document.getElementById('searchInput').value.toLowerCase();
        const stat   = document.getElementById('statusFilter').value;
        const role   = document.getElementById('roleFilter').value;
        const mgr    = document.getElementById('managerFilter').value;
        const dSkill = document.getElementById('domainSkillFilter').value;
        const tSkill = document.getElementById('toolSkillFilter').value;

        filteredData = teamData.filter(p => {
            const matchSearch = (p.name || '').toLowerCase().includes(term) || String(p.id).includes(term);
            const matchStat   = !stat || p.status === stat;
            const matchRole   = !role || p.role === role;
            const matchMgr    = !mgr || p.manager === mgr;
            const matchDS     = !dSkill || (p[dSkill] || 0) > 0;
            const matchTS     = !tSkill || (p[tSkill] || 0) > 0;
            return matchSearch && matchStat && matchRole && matchMgr && matchDS && matchTS;
        });

        renderTable();
        updateStats();
    }

    function resetFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('roleFilter').value = '';
        document.getElementById('managerFilter').value = '';
        document.getElementById('domainSkillFilter').value = '';
        document.getElementById('toolSkillFilter').value = '';
        filteredData = [...teamData];
        renderTable();
        updateStats();
    }

    function toggleView(view, evt) {
        currentView = view;
        document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
        if (evt && evt.target) evt.target.classList.add('active');

        const dCols = document.querySelectorAll('.domain-col');
        const tCols = document.querySelectorAll('.tools-col');

        if (view === 'domain') {
            dCols.forEach(c => c.style.display = '');
            tCols.forEach(c => c.style.display = 'none');
        } else if (view === 'tools') {
            dCols.forEach(c => c.style.display = 'none');
            tCols.forEach(c => c.style.display = '');
        } else {
            dCols.forEach(c => c.style.display = '');
            tCols.forEach(c => c.style.display = '');
        }
    }

    function updateStats() {
        const resignedCount   = teamData.filter(p => p.status === 'Resigned').length;
        const newJoineeCount  = teamData.filter(p => (p.newJoinee || '').toUpperCase() === 'Y').length;
        const billablePeople  = teamData.filter(p => p.status === 'Billable');

        document.getElementById('totalCount').textContent    = teamData.length;
        document.getElementById('activeCount').textContent   = billablePeople.length;
        document.getElementById('clientRoleCount').textContent =
            billablePeople.filter(p => (p.clientRole || '').toLowerCase() === 'y').length;

        document.getElementById('newJoineeCount').textContent = newJoineeCount;
        document.getElementById('resignedCount').textContent  = resignedCount;
    }

    function sortTable(col) {
        if (sortColumn === col) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            sortColumn = col;
            sortDirection = 'asc';
        }

        filteredData.sort((a, b) => {
            const valA = a[col] ?? 0;
            const valB = b[col] ?? 0;
            if (valA === valB) return 0;
            return sortDirection === 'asc' ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
        });

        renderTable();
    }

    function deleteUser(id) {
        if (confirm('Delete user? This will not delete from Google Sheets until you click Save Changes.')) {
            teamData    = teamData.filter(p => p.id != id);
            filteredData = filteredData.filter(p => p.id != id);
            renderTable();
            updateStats();
            updateLastModified();
        }
    }

    function populateModalDropdown(elementId, dataKey, currentValue) {
        const select = document.getElementById(elementId);
        select.innerHTML = '';
        const uniqueValues = [...new Set(teamData.map(item => item[dataKey]))].filter(x => x).sort();
        if (isAddingNew) {
            const empty = document.createElement('option');
            empty.value = '';
            empty.textContent = '-- Select --';
            select.appendChild(empty);
        }
        uniqueValues.forEach(val => {
            const option = document.createElement('option');
            option.value = val;
            option.textContent = val;
            if (val === currentValue) option.selected = true;
            select.appendChild(option);
        });
    }

    function openEditModal(employeeId) {
        isAddingNew = false;
        currentEditingId = employeeId;
        document.querySelector('.modal-header h2').textContent = "‚úèÔ∏è Edit Employee Details";

        const person = teamData.find(p => p.id == employeeId);
        if (person) {
            document.getElementById('editName').value = person.name || '';
            document.getElementById('editId').value   = person.id || '';
            document.getElementById('editId').disabled = true;
            document.getElementById('editStatus').value = person.status || 'Billable';
            document.getElementById('editClientRole').value =
                (person.clientRole || 'N').toUpperCase() === 'Y' ? 'Y' : 'N';
            document.getElementById('editNewJoinee').value =
                (person.newJoinee || 'N').toUpperCase() === 'Y' ? 'Y' : 'N';

            populateModalDropdown('editAlignment', 'alignment', person.alignment);
            populateModalDropdown('editManager',   'manager',   person.manager);
            populateModalDropdown('editRole',      'role',      person.role);

            document.getElementById('editModal').style.display = 'block';
        }
    }

    function openAddModal() {
        isAddingNew = true;
        currentEditingId = null;
        document.querySelector('.modal-header h2').textContent = "‚ûï Add New Team Member";

        document.getElementById('editName').value = '';
        document.getElementById('editId').value = '';
        document.getElementById('editId').disabled = false;
        document.getElementById('editStatus').value = 'Billable';
        document.getElementById('editClientRole').value = 'N';
        document.getElementById('editNewJoinee').value = 'N';

        populateModalDropdown('editAlignment', 'alignment', null);
        populateModalDropdown('editManager',   'manager',   null);
        populateModalDropdown('editRole',      'role',      null);

        document.getElementById('editModal').style.display = 'block';
    }

    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
        currentEditingId = null;
    }

    function saveEditChanges() {
        const name      = document.getElementById('editName').value.trim();
        const id        = document.getElementById('editId').value.trim();
        const status    = document.getElementById('editStatus').value;
        const alignment = document.getElementById('editAlignment').value;
        const manager   = document.getElementById('editManager').value;
        const role      = document.getElementById('editRole').value;
        const clientRole = document.getElementById('editClientRole').value;
        const newJoinee  = document.getElementById('editNewJoinee').value;

        if (!name || !id) {
            alert("Name and ID are required!");
            return;
        }

        if (isAddingNew) {
            if (teamData.some(p => p.id == id)) {
                alert("Error: This Employee ID already exists!");
                return;
            }
            const newPerson = {
                sno: teamData.length + 1,
                id, name, status,
                alignment: alignment || "TBD",
                manager:   manager   || "TBD",
                role:      role      || "TBD",
                clientRole,
                newJoinee,
                ...domainSkills.reduce((acc, s) => ({...acc, [s]: 0}), {}),
                ...toolSkills.reduce((acc, s) => ({...acc, [s]: 0}), {})
            };
            teamData.push(newPerson);
            alert(`Added ${name} locally. Don't forget to Save Changes.`);
        } else {
            const idx = teamData.findIndex(p => p.id == currentEditingId);
            if (idx !== -1) {
                teamData[idx].name       = name;
                teamData[idx].status     = status;
                teamData[idx].clientRole = clientRole;
                teamData[idx].newJoinee  = newJoinee;
                teamData[idx].alignment  = alignment;
                teamData[idx].manager    = manager;
                teamData[idx].role       = role;
                alert('Details updated locally.');
            }
        }

        closeEditModal();
        filteredData = [...teamData];
        applyFilters();
        updateStats();
        updateLastModified();
    }

    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
