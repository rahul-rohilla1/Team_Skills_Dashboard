<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Skill Matrix</title>
    <style> 
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; color: #333; }
        
        /* Header & Layout */
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header h1 { font-size: 28px; font-weight: 600; }
        .container { max-width: 100%; padding: 20px; }
        
        /* Controls & Filters */
        .controls { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .filter-section { margin-bottom: 15px; }
        .filter-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        
        /* Stats */
        .stats-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; }
        .stat-card .number { font-size: 32px; font-weight: 700; color: #667eea; }
        .stat-card .label { margin-top: 5px; font-size: 14px; color: #777; }

        /* Buttons */
        .action-buttons { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; align-items: center; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .btn-secondary { background: #e0e0e0; color: #333; }
        .btn-sm { padding: 5px 10px; font-size: 12px; }
        .btn-edit { background: #4caf50; color: white; }
        .btn-delete { background: #f44336; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        
        .last-modified { display: inline-block; margin-left: 15px; font-size: 12px; color: #666; font-style: italic; }

        /* Table */
        .table-container { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden; }
        .table-wrapper { overflow-x: auto; max-height: 70vh; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        thead { position: sticky; top: 0; z-index: 100; background: white; }
        
        /* Header Styling */
        .header-level-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center; padding: 12px 10px; border: 1px solid #5568d3; }
        .header-level-2 { background: #e8eaf6; color: #333; text-align: center; padding: 10px 8px; border: 1px solid #c5cae9; }
        .header-level-3 { background: #f8f9fa; padding: 10px 8px; border: 1px solid #dee2e6; white-space: nowrap; cursor: pointer; }
        .header-basic { background: #f8f9fa; padding: 10px 8px; border: 1px solid #dee2e6; }
        
        td { padding: 10px 8px; border: 1px solid #f0f0f0; text-align: center; }
        tbody tr:hover { background: #f8f9fa; }

        /* Skills & Badges */
        .skill-level { display: inline-block; padding: 4px 8px; border-radius: 3px; min-width: 30px; cursor: pointer; }
        .skill-level:hover { transform: scale(1.1); box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        .level-0 { background: #f5f5f5; color: #999; }
        .level-1 { background: #ffebee; color: #c62828; }
        .level-2 { background: #fff3e0; color: #e65100; }
        .level-3 { background: #fff9c4; color: #f57f17; }
        .level-4 { background: #e8f5e9; color: #2e7d32; }
        .level-5 { background: #c8e6c9; color: #1b5e20; }

        .status-badge { padding: 4px 10px; border-radius: 12px; font-weight: 600; font-size: 11px; }
        .status-Billable, .status-Active { background: #e8f5e9; color: #2e7d32; }
        .status-Maternity, .status-Developmental { background: #fff3e0; color: #e65100; }
        .status-Resigned { background: #ffebee; color: #c62828; }
        .status-Shadow, .status-OPAS { background: #e3f2fd; color: #1976d2; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow: auto; }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 30px; border-radius: 8px; width: 90%; max-width: 600px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; }
        .close { font-size: 28px; font-weight: bold; cursor: pointer; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px; }
        
        /* Utils */
        .view-toggle { display: flex; gap: 10px; margin-bottom: 15px; }
        .toggle-btn { padding: 8px 16px; border: 2px solid #667eea; background: white; color: #667eea; border-radius: 4px; cursor: pointer; }
        .toggle-btn.active { background: #667eea; color: white; }
        .export-section { padding: 15px 20px; background: #f8f9fa; display: flex; justify-content: space-between; }

                /* --- NEW CSS FOR LEGEND LAYOUT --- */

        /* Create a Flex container to put Filters (Left) and Legend (Right) side-by-side */
        .controls-wrapper {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .controls-left {
            flex: 1; /* Takes up remaining space */
        }

        .controls-right {
            width: 320px; /* Fixed width for the legend */
            flex-shrink: 0;
        }

        /* Styling the Legend Table */
        .legend-box {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 0;
            overflow: hidden;
            font-size: 11px; /* Keep it small */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .legend-table {
            width: 100%;
            border-collapse: collapse;
        }

        .legend-table th {
            background: #667eea;
            color: white;
            padding: 6px;
            text-align: left;
            font-weight: 600;
        }

        .legend-table td {
            padding: 5px 8px;
            border-bottom: 1px solid #f0f0f0;
            color: #444;
            vertical-align: middle;
            text-align: left; /* Align text left */
        }

        .legend-table tr:last-child td {
            border-bottom: none;
        }

        /* Small colored badge for the number */
        .rating-badge {
            display: inline-block;
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            border-radius: 3px;
            font-weight: bold;
            margin-right: 8px;
            font-size: 10px;
        }

        /* Responsive: On mobile, stack them vertically */
        @media (max-width: 1200px) {
            .controls-wrapper {
                flex-direction: column;
            }
            .controls-right {
                width: 100%;
                margin-top: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéØ Team Skill Matrix</h1>
        <p>Comprehensive Team Skills & Expertise Overview</p>
    </div>

    <div class="container">
        <div class="stats-bar">
            <div class="stat-card"><div class="number" id="totalCount">0</div><div class="label">Total Team Members</div></div>
            <div class="stat-card"><div class="number" id="activeCount">0</div><div class="label">Billable Members</div></div>
            <div class="stat-card"><div class="number" id="clientRoleCount">0</div><div class="label">Client Roles</div></div>
            <div class="stat-card"><div class="number" id="avgSkillLevel">0</div><div class="label">Avg Domain Skill</div></div>
            <div class="stat-card"><div class="number" id="avgToolLevel">0</div><div class="label">Avg Tool Skill</div></div>
        </div>

        <div class="controls">
    <div class="controls-wrapper">
        
        <div class="controls-left">
            <div class="info-message">
                üí° <strong>Tip:</strong> Click on any skill number to edit (0-5).
            </div>

            <div class="view-toggle">
                <button class="toggle-btn active" onclick="toggleView('all')">üìä All Skills</button>
                <button class="toggle-btn" onclick="toggleView('domain')">üéØ Domain Only</button>
                <button class="toggle-btn" onclick="toggleView('tools')">üîß Tools Only</button>
            </div>

            <div class="filter-row">
                <div><label>üîç Search</label><input type="text" id="searchInput" placeholder="Name or ID..."></div>
                <div><label>üëî Status</label><select id="statusFilter"><option value="">All Status</option></select></div>
                <div><label>üìä Role</label><select id="roleFilter"><option value="">All Roles</option></select></div>
                <div><label>üë§ Manager</label><select id="managerFilter"><option value="">All Managers</option></select></div>
            </div>

            <div class="filter-section">
                <label>üíº Filter by Skill (>0)</label>
                <div class="filter-row">
                    <div><label>Domain</label><select id="domainSkillFilter"><option value="">All Domain Skills</option></select></div>
                    <div><label>Tool</label><select id="toolSkillFilter"><option value="">All Tools</option></select></div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-success" onclick="openAddModal()">‚ûï Add Member</button>
                <button class="btn btn-primary" onclick="resetFilters()">üîÑ Reset</button>
                <button class="btn btn-secondary" onclick="saveAllChanges()">üíæ Save to Cloud</button>
                <span id="lastModified" class="last-modified">Last Modified: Never</span>
            </div>
        </div>

        <div class="controls-right">
            <div class="legend-box">
                <table class="legend-table">
                    <thead>
                        <tr>
                            <th colspan="2">‚ÑπÔ∏è Skill Rating Definitions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="rating-badge level-0">0</span> Not at all Aware</td>
                        </tr>
                        <tr>
                            <td><span class="rating-badge level-1">1</span> Trained</td>
                        </tr>
                        <tr>
                            <td><span class="rating-badge level-2">2</span> At least worked on a POC</td>
                        </tr>
                        <tr>
                            <td><span class="rating-badge level-3">3</span> Worked on a complete Project</td>
                        </tr>
                        <tr>
                            <td><span class="rating-badge level-4">4</span> Independently handled project</td>
                        </tr>
                        <tr>
                            <td><span class="rating-badge level-5">5</span> Guide Others and Solved doubts</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
    </div> </div>

        <div class="table-container">
            <div class="table-wrapper">
                <table id="skillTable">
                    <thead>
                        <tr id="headerRow1">
                            <th rowspan="3" class="header-basic">S.No</th>
                            <th rowspan="3" class="header-basic">ID</th>
                            <th rowspan="3" class="header-basic">Name</th>
                            <th rowspan="3" class="header-basic">Status</th>
                            <th rowspan="3" class="header-basic">Alignment</th>
                            <th rowspan="3" class="header-basic">Manager</th>
                            <th rowspan="3" class="header-basic">Role</th>
                            <th rowspan="3" class="header-basic">Client</th>
                            <th colspan="15" class="header-level-1 domain-col">DOMAIN EXPERTISE</th>
                            <th colspan="18" class="header-level-1 tools-col">TOOLS & TECHNOLOGIES</th>
                            <th rowspan="3" class="header-basic">Actions</th>
                        </tr>
                        <tr id="headerRow2">
                            <th colspan="15" class="header-level-2 domain-col">Core Domain Skills</th>
                            <th colspan="4" class="header-level-2 tools-col">Data Viz</th>
                            <th colspan="5" class="header-level-2 tools-col">Programming</th>
                            <th colspan="7" class="header-level-2 tools-col">Data Mgmt</th>
                            <th colspan="2" class="header-level-2 tools-col">Cloud</th>
                        </tr>
                        <tr id="headerRow3">
                            <th class="header-level-3 sortable domain-col" data-column="marketAccess">Market Access</th>
                            <th class="header-level-3 sortable domain-col" data-column="pricingAnalytics">Pricing</th>
                            <th class="header-level-3 sortable domain-col" data-column="salesForce">SFE</th>
                            <th class="header-level-3 sortable domain-col" data-column="incentiveComp">IC</th>
                            <th class="header-level-3 sortable domain-col" data-column="patientData">Patient Data</th>
                            <th class="header-level-3 sortable domain-col" data-column="forecasting">Forecasting</th>
                            <th class="header-level-3 sortable domain-col" data-column="pharmaAnalytics">Pharma</th>
                            <th class="header-level-3 sortable domain-col" data-column="marketingAnalytics">Marketing</th>
                            <th class="header-level-3 sortable domain-col" data-column="supplyChain">Supply Chain</th>
                            <th class="header-level-3 sortable domain-col" data-column="fpna">FP&A</th>
                            <th class="header-level-3 sortable domain-col" data-column="targeting">Targeting</th>
                            <th class="header-level-3 sortable domain-col" data-column="dataEngineering">Data Eng</th>
                            <th class="header-level-3 sortable domain-col" data-column="etl">ETL</th>
                            <th class="header-level-3 sortable domain-col" data-column="advancedAnalytics">Adv Analytics</th>
                            <th class="header-level-3 sortable domain-col" data-column="dataScience">Data Sci</th>

                            <th class="header-level-3 sortable tools-col" data-column="excelVBA">Excel/VBA</th>
                            <th class="header-level-3 sortable tools-col" data-column="tableau">Tableau</th>
                            <th class="header-level-3 sortable tools-col" data-column="powerBI">Power BI</th>
                            <th class="header-level-3 sortable tools-col" data-column="ssrs">SSRS</th>
                            <th class="header-level-3 sortable tools-col" data-column="sql">SQL</th>
                            <th class="header-level-3 sortable tools-col" data-column="python">Python</th>
                            <th class="header-level-3 sortable tools-col" data-column="sas">SAS</th>
                            <th class="header-level-3 sortable tools-col" data-column="r">R</th>
                            <th class="header-level-3 sortable tools-col" data-column="powerQuery">P.Query</th>
                            <th class="header-level-3 sortable tools-col" data-column="apacheAirflow">Airflow</th>
                            <th class="header-level-3 sortable tools-col" data-column="ssis">SSIS</th>
                            <th class="header-level-3 sortable tools-col" data-column="awsGlue">Glue</th>
                            <th class="header-level-3 sortable tools-col" data-column="adf">ADF</th>
                            <th class="header-level-3 sortable tools-col" data-column="alteryx">Alteryx</th>
                            <th class="header-level-3 sortable tools-col" data-column="knime">KNIME</th>
                            <th class="header-level-3 sortable tools-col" data-column="talend">Talend</th>
                            <th class="header-level-3 sortable tools-col" data-column="databricks">Databricks</th>
                            <th class="header-level-3 tools-col">Cloud</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            <div class="export-section">
                <div>Showing <strong id="showingCount">0</strong> of <strong id="totalRecords">0</strong> records</div>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Edit Employee Details</h2>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            
            <div class="form-group">
                <label for="editName">Full Name</label>
                <input type="text" id="editName" placeholder="Enter full name">
            </div>

            <div class="filter-row" style="margin-bottom:0;">
                <div class="form-group">
                    <label for="editId">Employee ID</label>
                    <input type="number" id="editId" placeholder="ID">
                </div>
                <div class="form-group">
                    <label for="editClientRole">Client Role?</label>
                    <select id="editClientRole">
                        <option value="Y">Yes</option>
                        <option value="N">No</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="editStatus">Status</label>
                <select id="editStatus">
                    <option value="Billable">Billable</option>
                    <option value="Active">Active</option>
                    <option value="Shadow">Shadow</option>
                    <option value="Maternity">Maternity</option>
                    <option value="Resigned">Resigned</option>
                    <option value="OPAS">OPAS</option>
                    <option value="Developmental">Developmental</option>
                    <option value="Future billable">Future billable</option>
                </select>
            </div>

            <div class="form-group">
                <label for="editAlignment">Alignment</label>
                <select id="editAlignment"></select>
            </div>

            <div class="form-group">
                <label for="editManager">Reporting Manager</label>
                <select id="editManager"></select>
            </div>

            <div class="form-group">
                <label for="editRole">Role</label>
                <select id="editRole"></select>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveEditChanges()">üíæ Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. SETUP
        // ==========================================
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxW_3-qr7J-aTam5kyOzcG4CgAB7J1MlnaI3TtKYDOi6InPwWCiK75fYi_tGmAQb0JK/exec"; // <--- PASTE HERE
        
        let teamData = []; // Initially empty, fetched from sheet
        let filteredData = [];
        
        const domainSkills = ['marketAccess', 'pricingAnalytics', 'salesForce', 'incentiveComp', 'patientData', 'forecasting', 'pharmaAnalytics', 'marketingAnalytics', 'supplyChain', 'fpna', 'targeting', 'dataEngineering', 'etl', 'advancedAnalytics', 'dataScience'];
        const toolSkills = ['excelVBA', 'tableau', 'powerBI', 'ssrs', 'sql', 'python', 'sas', 'r', 'powerQuery', 'apacheAirflow', 'ssis', 'awsGlue', 'adf', 'alteryx', 'knime', 'talend', 'databricks'];
        const skillLabels = { 'marketAccess': 'Market Access', 'pricingAnalytics': 'Pricing', 'salesForce': 'SFE', 'incentiveComp': 'IC', 'patientData': 'Patient Data', 'forecasting': 'Forecasting', 'pharmaAnalytics': 'Pharma', 'marketingAnalytics': 'Marketing', 'supplyChain': 'Supply Chain', 'fpna': 'FP&A', 'targeting': 'Targeting', 'dataEngineering': 'Data Eng', 'etl': 'ETL', 'advancedAnalytics': 'Advanced', 'dataScience': 'Data Sci', 'excelVBA': 'Excel', 'tableau': 'Tableau', 'powerBI': 'Power BI', 'ssrs': 'SSRS', 'sql': 'SQL', 'python': 'Python', 'sas': 'SAS', 'r': 'R', 'powerQuery': 'Power Query', 'apacheAirflow': 'Airflow', 'ssis': 'SSIS', 'awsGlue': 'AWS Glue', 'adf': 'ADF', 'alteryx': 'Alteryx', 'knime': 'KNIME', 'talend': 'Talend', 'databricks': 'Databricks' };
        
        let sortColumn = null;
        let sortDirection = 'asc';
        let currentEditingId = null;
        let currentView = 'all';
        let isAddingNew = false;

        // ==========================================
        // 2. INITIALIZATION
        // ==========================================
        async function init() {
            // Show loading state
            document.getElementById('tableBody').innerHTML = '<tr><td colspan="45" style="text-align:center;padding:20px;">‚è≥ Loading data...</td></tr>';
            
            try {
                const response = await fetch(WEB_APP_URL);
                const data = await response.json();
                
                if (Array.isArray(data)) {
                    teamData = data;
                    // Fix string/number issues
                    teamData.forEach(p => {
                        domainSkills.forEach(s => p[s] = parseInt(p[s]) || 0);
                        toolSkills.forEach(s => p[s] = parseInt(p[s]) || 0);
                    });
                }
                
                filteredData = [...teamData];
                populateFilters();
                renderTable();
                updateStats();
                attachEventListeners(); // THIS IS THE MISSING FUNCTION WE ARE FIXING
                
            } catch (error) {
                console.error(error);
                document.getElementById('tableBody').innerHTML = `<tr><td colspan="45" style="text-align:center;color:red;padding:20px;">‚ùå Error loading data. Did you paste the correct URL? Error: ${error.message}</td></tr>`;
            }
        }

        // THE MISSING FUNCTION IS HERE NOW:
        function attachEventListeners() {
            document.querySelectorAll('.sortable').forEach(th => th.addEventListener('click', () => sortTable(th.dataset.column)));
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            ['statusFilter','roleFilter','managerFilter','domainSkillFilter','toolSkillFilter'].forEach(id => {
                document.getElementById(id).addEventListener('change', applyFilters);
            });
            window.onclick = function(e) { if(e.target == document.getElementById('editModal')) closeEditModal(); }
        }

        // ==========================================
        // 3. CORE LOGIC
        // ==========================================
        async function saveAllChanges() {
            const btn = document.querySelector('button[onclick="saveAllChanges()"]');
            const originalText = btn.textContent;
            btn.textContent = "‚è≥ Saving...";
            btn.disabled = true;

            try {
                const response = await fetch(WEB_APP_URL, {
                    method: "POST",
                    body: JSON.stringify(teamData),
                    headers: { "Content-Type": "text/plain" }
                });
                const result = await response.json();
                
                if (result.status === "success") {
                    alert(`‚úÖ Successfully saved to Cloud!`);
                    updateLastModified();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                alert("‚ùå Failed to save: " + error.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        function updateLastModified() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            document.getElementById('lastModified').textContent = `Last Modified: ${timeString}`;
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            if(filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="45" style="text-align:center;padding:20px;">No records found</td></tr>';
                document.getElementById('showingCount').textContent = 0;
                return;
            }

            filteredData.forEach(p => {
                const tr = document.createElement('tr');
                const statusClass = 'status-' + (p.status || '').replace(/[\s-]/g, '');
                
                let html = `
                    <td>${p.sno}</td>
                    <td><strong>${p.id}</strong></td>
                    <td><strong>${p.name}</strong></td>
                    <td><span class="status-badge ${statusClass}">${p.status}</span></td>
                    <td>${p.alignment}</td>
                    <td>${p.manager}</td>
                    <td>${p.role}</td>
                    <td><strong>${p.clientRole}</strong></td>`;

                if(currentView !== 'tools') {
                    domainSkills.forEach(s => html += `<td class="domain-col"><span class="skill-level level-${p[s]}" onclick="makeSkillEditable(this,'${p.id}','${s}')">${p[s]}</span></td>`);
                }
                if(currentView !== 'domain') {
                    toolSkills.forEach(s => html += `<td class="tools-col"><span class="skill-level level-${p[s]}" onclick="makeSkillEditable(this,'${p.id}','${s}')">${p[s]}</span></td>`);
                    html += `<td class="tools-col">-</td>`;
                }

                html += `<td><div class="action-cell">
                        <button class="btn btn-edit btn-sm" onclick="openEditModal('${p.id}')">‚úèÔ∏è</button>
                        <button class="btn btn-delete btn-sm" onclick="deleteUser('${p.id}')">üóëÔ∏è</button>
                    </div></td>`;
                
                tr.innerHTML = html;
                tbody.appendChild(tr);
            });
            document.getElementById('showingCount').textContent = filteredData.length;
            document.getElementById('totalRecords').textContent = teamData.length;
        }

        function makeSkillEditable(el, empId, skill) {
            const orig = el.textContent;
            el.setAttribute('contenteditable', 'true');
            el.focus();
            
            const onBlur = () => {
                el.setAttribute('contenteditable', 'false');
                const val = parseInt(el.textContent);
                if(isNaN(val) || val < 0 || val > 5) {
                    el.textContent = orig;
                    alert('Value must be 0-5');
                } else {
                    const pIdx = teamData.findIndex(p => p.id == empId);
                    if(pIdx !== -1) {
                        teamData[pIdx][skill] = val;
                        el.className = `skill-level level-${val}`;
                        updateStats();
                        updateLastModified();
                    }
                }
            };
            el.addEventListener('blur', onBlur, {once:true});
            el.addEventListener('keydown', (e) => { if(e.key==='Enter') { e.preventDefault(); el.blur(); }});
        }

        // ==========================================
        // 4. FILTERS & HELPERS
        // ==========================================
        function populateFilters() {
            const statuses = [...new Set(teamData.map(d => d.status))].filter(s => s).sort();
            const roles = [...new Set(teamData.map(d => d.role))].filter(r => r).sort();
            const managers = [...new Set(teamData.map(d => d.manager))].filter(m => m).sort();

            const fillSelect = (id, data) => {
                const select = document.getElementById(id);
                select.innerHTML = '<option value="">All</option>';
                data.forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item; opt.textContent = item;
                    select.appendChild(opt);
                });
            };
            fillSelect('statusFilter', statuses);
            fillSelect('roleFilter', roles);
            fillSelect('managerFilter', managers);
            
            // Skills
            const dFilter = document.getElementById('domainSkillFilter');
            if(dFilter.options.length === 1) {
                domainSkills.forEach(s => { let o = document.createElement('option'); o.value=s; o.textContent=skillLabels[s]; dFilter.appendChild(o); });
                const tFilter = document.getElementById('toolSkillFilter');
                toolSkills.forEach(s => { let o = document.createElement('option'); o.value=s; o.textContent=skillLabels[s]; tFilter.appendChild(o); });
            }
        }

        function applyFilters() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const stat = document.getElementById('statusFilter').value;
            const role = document.getElementById('roleFilter').value;
            const mgr = document.getElementById('managerFilter').value;
            const dSkill = document.getElementById('domainSkillFilter').value;
            const tSkill = document.getElementById('toolSkillFilter').value;

            filteredData = teamData.filter(p => {
                const matchSearch = (p.name||'').toLowerCase().includes(term) || String(p.id).includes(term);
                const matchStat = !stat || p.status === stat;
                const matchRole = !role || p.role === role;
                const matchMgr = !mgr || p.manager === mgr;
                const matchDS = !dSkill || p[dSkill] > 0;
                const matchTS = !tSkill || p[tSkill] > 0;
                return matchSearch && matchStat && matchRole && matchMgr && matchDS && matchTS;
            });
            renderTable();
            updateStats();
        }

        function toggleView(view) {
            currentView = view;
            document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const dCols = document.querySelectorAll('.domain-col');
            const tCols = document.querySelectorAll('.tools-col');
            const dFilt = document.getElementById('domainSkillFilter').parentElement;
            const tFilt = document.getElementById('toolSkillFilter').parentElement;

            if(view === 'domain') {
                dCols.forEach(c => c.style.display = ''); tCols.forEach(c => c.style.display = 'none');
                dFilt.style.display='block'; tFilt.style.display='none';
            } else if(view === 'tools') {
                dCols.forEach(c => c.style.display = 'none'); tCols.forEach(c => c.style.display = '');
                dFilt.style.display='none'; tFilt.style.display='block';
            } else {
                dCols.forEach(c => c.style.display = ''); tCols.forEach(c => c.style.display = '');
                dFilt.style.display='block'; tFilt.style.display='block';
            }
        }

        function updateStats() {
            document.getElementById('totalCount').textContent = teamData.length;
            document.getElementById('activeCount').textContent = teamData.filter(p => p.status === 'Billable').length;
            document.getElementById('clientRoleCount').textContent = teamData.filter(p => (p.clientRole||'').toLowerCase() === 'y').length;
            
            let dSum=0, dCount=0, tSum=0, tCount=0;
            teamData.forEach(p => {
                domainSkills.forEach(s => { dSum+=p[s]||0; dCount++; });
                toolSkills.forEach(s => { tSum+=p[s]||0; tCount++; });
            });
            document.getElementById('avgSkillLevel').textContent = dCount ? (dSum/dCount).toFixed(1) : 0;
            document.getElementById('avgToolLevel').textContent = tCount ? (tSum/tCount).toFixed(1) : 0;
        }

        function sortTable(col) {
            if(sortColumn === col) sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            else { sortColumn = col; sortDirection = 'asc'; }
            
            filteredData.sort((a,b) => {
                let valA = a[col], valB = b[col];
                return sortDirection === 'asc' ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
            });
            renderTable();
        }

        function deleteUser(id) {
            if(confirm('Delete user? This will not delete from Google Sheets until you click Save.')) {
                teamData = teamData.filter(p => p.id != id);
                filteredData = filteredData.filter(p => p.id != id);
                renderTable();
                updateStats();
                updateLastModified();
            }
        }

        // ==========================================
        // 5. MODAL LOGIC
        // ==========================================
        function populateModalDropdown(elementId, dataKey, currentValue) {
            const select = document.getElementById(elementId);
            select.innerHTML = ''; 
            const uniqueValues = [...new Set(teamData.map(item => item[dataKey]))].filter(x => x).sort();
            if(isAddingNew) {
                const empty = document.createElement('option'); empty.value = ''; empty.textContent = '-- Select --'; select.appendChild(empty);
            }
            uniqueValues.forEach(val => {
                const option = document.createElement('option');
                option.value = val; option.textContent = val;
                if (val === currentValue) option.selected = true;
                select.appendChild(option);
            });
        }

        function openEditModal(employeeId) {
            isAddingNew = false;
            currentEditingId = employeeId;
            document.querySelector('.modal-header h2').textContent = "‚úèÔ∏è Edit Employee Details";

            const person = teamData.find(p => p.id == employeeId);
            if (person) {
                document.getElementById('editName').value = person.name;
                document.getElementById('editId').value = person.id;
                document.getElementById('editId').disabled = true; 
                document.getElementById('editStatus').value = person.status;
                document.getElementById('editClientRole').value = (person.clientRole||'N').toUpperCase() === 'Y' ? 'Y' : 'N';
                
                populateModalDropdown('editAlignment', 'alignment', person.alignment);
                populateModalDropdown('editManager', 'manager', person.manager);
                populateModalDropdown('editRole', 'role', person.role);
                document.getElementById('editModal').style.display = 'block';
            }
        }

        function openAddModal() {
            isAddingNew = true;
            currentEditingId = null;
            document.querySelector('.modal-header h2').textContent = "‚ûï Add New Team Member";

            document.getElementById('editName').value = '';
            document.getElementById('editId').value = '';
            document.getElementById('editId').disabled = false; 
            document.getElementById('editStatus').value = 'Billable';
            document.getElementById('editClientRole').value = 'N';

            populateModalDropdown('editAlignment', 'alignment', null);
            populateModalDropdown('editManager', 'manager', null);
            populateModalDropdown('editRole', 'role', null);
            document.getElementById('editModal').style.display = 'block';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            currentEditingId = null;
        }

        function saveEditChanges() {
            const name = document.getElementById('editName').value;
            const id = document.getElementById('editId').value;
            const status = document.getElementById('editStatus').value;
            const alignment = document.getElementById('editAlignment').value;
            const manager = document.getElementById('editManager').value;
            const role = document.getElementById('editRole').value;
            const clientRole = document.getElementById('editClientRole').value;

            if (!name || !id) { alert("Name and ID are required!"); return; }

            if (isAddingNew) {
                if (teamData.some(p => p.id == id)) { alert("Error: This Employee ID already exists!"); return; }
                const newPerson = {
                    "sno": teamData.length + 1, "id": id, "name": name, "status": status, "alignment": alignment || "TBD", "manager": manager || "TBD", "role": role || "TBD", "clientRole": clientRole,
                    ...domainSkills.reduce((acc, s) => ({...acc, [s]: 0}), {}),
                    ...toolSkills.reduce((acc, s) => ({...acc, [s]: 0}), {})
                };
                teamData.push(newPerson);
                alert(`Added ${name} locally. Don't forget to Save to Cloud!`);
            } else {
                const personIndex = teamData.findIndex(p => p.id == currentEditingId);
                if (personIndex !== -1) {
                    teamData[personIndex].name = name;
                    teamData[personIndex].status = status;
                    teamData[personIndex].clientRole = clientRole;
                    teamData[personIndex].alignment = alignment;
                    teamData[personIndex].manager = manager;
                    teamData[personIndex].role = role;
                    alert('Details updated locally.');
                }
            }
            closeEditModal();
            filteredData = [...teamData]; // Reset filter buffer
            applyFilters(); // Re-render
            updateStats();
            updateLastModified();
        }

        // Start
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
